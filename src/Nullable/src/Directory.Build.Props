<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="CopyToCSPPFilesFolder; GenerateInternalsVisibleTo" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory).., Directory.Build.props))\Directory.Build.props" />

  <!-- FOR DEVELOPEMENT AND PACKAGE CREATION -->

  <PropertyGroup>
    <ImportDirectoryBuildTargets>false</ImportDirectoryBuildTargets>
  </PropertyGroup>

  <ItemGroup>
    <!-- Search for .cs-files one level deep. Otherwise we would have to exclude Properties/* manually. -->
    <NonCSPPFiles Include="$(MSBuildThisFileDirectory)*.cs">
      <CSPPFilePath>$(MSBuildThisFileDirectory)obj/StaticAnalysisAttributes/%(RecursiveDir)/%(Filename).cs.pp</CSPPFilePath>

      <AnnotatedWithExcludeFromCodeCoverage>false</AnnotatedWithExcludeFromCodeCoverage>
      <AnnotatedWithExcludeFromCodeCoverage Condition="$([System.String]::Copy(%(Filename)).Contains('ExcludeFromCodeCoverage'))">true</AnnotatedWithExcludeFromCodeCoverage>

      <IsMemberNotNullOrWhenAttribute>false</IsMemberNotNullOrWhenAttribute>
      <IsMemberNotNullOrWhenAttribute Condition="$([System.String]::Copy(%(Filename)).Contains('MemberNotNullAttribute'))
                                Or $([System.String]::Copy(%(Filename)).Contains('IsMemberNotNullWhenAttribute'))">true</IsMemberNotNullOrWhenAttribute>
    </NonCSPPFiles>

    <!-- Needed when we search more than one level deep (globbing). -->
    <!--<NonCSPPFiles Remove="obj/**/*.cs" />-->
    <!--<NonCSPPFiles Remove="Properties/**/*.cs" />-->

    <NetStandard1_0CompliantNonCSPPFiles Include="@(NonCSPPFiles->WithMetadataValue('AnnotatedWithExcludeFromCodeCoverage','false'))"/>

    <Net20CompliantNonCSPPFiles Include="@(NetStandard1_0CompliantNonCSPPFiles)" />

    <NetStandard2_0CompliantNonCSPPFiles Include="@(NonCSPPFiles)" />
    <Net40CompliantNonCSPPFiles Include="@(NonCSPPFiles)" />

    <NetStandard2_1CompliantNonCSPPFiles Include="@(NonCSPPFiles->WithMetadataValue('IsMemberNotNullOrWhenAttribute','true'))" />

    <Net5_0CompliantNonCSPPFiles Include="$(MSBuildThisFileDirectory)content/_._">
      <CSPPFilePath>%(FullPath)</CSPPFilePath>
    </Net5_0CompliantNonCSPPFiles>
  </ItemGroup>

  <Target Name="CopyToCSPPFilesFolder"
          Inputs="@(NonCSPPFiles)"
          Outputs="@(NonCSPPFiles->'%(CSPPFilePath)')">

    <Copy SourceFiles="@(NonCSPPFiles)" DestinationFiles="%(CSPPFilePath)"></Copy>
  </Target>

  <!-- THIS IS FOR TERONIS.DOTNET -->
  
  <UsingTask TaskName="GetSolutionProjects" AssemblyFile="$(MSBuildBuildTasksAssemblyFile)" />

  <!-- No Inputs/Outputs needed: autogeneration of AssemblyInfo supports already cache. -->
  <Target Name="GenerateInternalsVisibleTo">

    <GetSolutionProjects Solution="$(TeronisDotNetSolutionPath)">
      <Output ItemName="ProjectFiles" TaskParameter="Output"/>
    </GetSolutionProjects>

    <ItemGroup>
      <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleTo">
        <_Parameter1>%(ProjectFiles.ProjectName)</_Parameter1> 
      </AssemblyAttribute>
    </ItemGroup>

  </Target>

</Project>
